{{- partial "settings.html" . -}}
{{- $id := ($.Scratch.Get "settings").name -}}
<style>
    .tvp-iframe {
        width: {{ ($.Scratch.Get "settings").iframe_width }};
    }

    .tvp-iframe-holder {
      position: relative;
      opacity: 0;
      height: 0;
      visibility: hidden;
    }

    .tvp-iframe-holder.enabled {
      height: auto;
      opacity: 1;
      visibility: visible;
      background: {{ ($.Scratch.Get "settings").background }};
      margin: {{ ($.Scratch.Get "settings").margin }};
    }

    .tvp-carousel-title {
        font-size: {{ ($.Scratch.Get "settings").modal_title_font_size }};
        font-family: {{ ($.Scratch.Get "settings").modal_title_font_family }};
    }

    .tvp-modal-header {
        padding: {{ ($.Scratch.Get "settings").modal_header_padding }};
        border-bottom:{{ ($.Scratch.Get "settings").modal_header_border_bottom }};
    }

    .tvp-modal-content {
        background:{{ ($.Scratch.Get "settings").modal_background }};
        border:{{ ($.Scratch.Get "settings").modal_border }};
    }

    .tvp-modal-title {
        color: {{ ($.Scratch.Get "settings").modal_title_font_color }};
        font-size: {{ ($.Scratch.Get "settings").modal_title_font_size }};
        font-family: {{ ($.Scratch.Get "settings").modal_title_font_family }};
        font-weight: {{ ($.Scratch.Get "settings").modal_title_font_weight }};
    }

    .tvp-products-headline {
        display: {{ ($.Scratch.Get "settings").products_headline_display }};
        color: {{ ($.Scratch.Get "settings").products_headline_font_color }};
        font-size: {{ ($.Scratch.Get "settings").products_headline_font_size }};
        top: {{ ($.Scratch.Get "settings").products_headline_top }};
        right: {{ ($.Scratch.Get "settings").products_headline_right }};
    }

    .tvp-modal-close {
        width: {{ ($.Scratch.Get "settings").modal_close_button_width }};
        height: {{ ($.Scratch.Get "settings").modal_close_button_height }};
        padding: {{ ($.Scratch.Get "settings").modal_close_button_padding }};
        background-color: {{ ($.Scratch.Get "settings").modal_close_button_background_color }};
        background-image: url("{{ $.Site.BaseURL }}carousel/{{ ($.Scratch.Get "settings").modal_close_button_background_image_url }}");
        border: {{ ($.Scratch.Get "settings").modal_close_button_border }};
        border-radius: {{ ($.Scratch.Get "settings").modal_close_button_border_radius }};
        box-shadow: {{ ($.Scratch.Get "settings").modal_close_button_box_shadow }};
        right: {{ ($.Scratch.Get "settings").modal_close_button_right }};
        top: {{ ($.Scratch.Get "settings").modal_close_button_top }};
        opacity: {{ ($.Scratch.Get "settings").modal_close_button_opacity }};
    }

    .tvp-modal-close > svg {
      display: {{ ($.Scratch.Get "settings").modal_close_button_svg_display }};
    }

    .tvp-modal-close:hover {
        background-color: {{ ($.Scratch.Get "settings").modal_close_button_background_hover }};
        opacity: {{ ($.Scratch.Get "settings").modal_close_button_opacity_hover }};
    }
</style>
<script id="tvp-modal-overlay-template" type="text/template">
    <div id="tvp-modal-overlay-{{ $id }}" class="tvp-modal-overlay tvp-hidden"></div>
</script>
<script id="tvp-modal-template" type="text/template">
    <div id="tvp-modal-{{ $id }}" class="tvp-modal tvp-hidden">
        <div class="tvp-modal-wrapper">
            <div class="tvp-modal-content">
                <div id="tvp-modal-header-{{ $id }}" class="tvp-modal-header">
                    <div id="tvp-modal-close-{{ $id }}" class="tvp-modal-close">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path fill="#ffffff" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                            <path d="M0 0h24v24H0z" fill="none"></path>
                        </svg>
                    </div>
                    <div id="tvp-modal-title-top-{{ $id }}" class="tvp-modal-title-top"></div>
                </div>
                <div class="tvp-modal-body">
                    <div id="tvp-modal-iframe-holder-{{ $id }}" class="tvp-modal-iframe-holder">
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>
<script id="tvp-iframe-modal-template" type="text/template">
    <div id="{{ $id }}" class="tvp-clearfix iframe-content">
        <div class="tvp-player-holder">
            <div class="tvp-player">
                <div id="tvp-player-el"></div>
            </div>
        </div>
        <div class="tvp-products-holder"></div>
    </div>
</script>
<script id="tvp-iframe-modal-mobile-template" type="text/template">
    <div id="{{ $id }}" class="tvp-clearfix iframe-content">
        <div class="tvp-player">
            <div id="tvp-player-el"></div>
        </div>
        <div class="tvp-products">
            <div class="tvp-products-carousel"></div>
        </div>
    </div>
</script>
<div id='{{ $id }}-holder' class="tvp-iframe-holder">
    <iframe class="tvp-iframe" src="about:blank" allowfullscreen frameborder="0" scrolling="no"></iframe>
    <script id="{{ $id }}-script">
        var widgetId = "{{ $id }}";
        var isIOS = /iPad|iPhone|iPod|iPhone Simulator|iPad Simulator/.test(navigator.userAgent) && !window.MSStream;
        var isset = function(o,p){
            var val = o;
            if (p) val = o[p];
            return 'undefined' !== typeof val;
        };
        var extend = function(o) {
            o = o || {};
            for (var i = 1; i < arguments.length; i++) {
                if (!arguments[i]) continue;
                for (var key in arguments[i]) {
                    if (arguments[i].hasOwnProperty(key)) {
                        o[key] = arguments[i][key];
                    }
                }
            }
            return o;
        };

        var createModal = function() {
            var modalOverlay = document.getElementById('tvp-modal-overlay-template').innerHTML;
            var modal = document.getElementById('tvp-modal-template').innerHTML;

            document.body.innerHTML += modalOverlay;
            document.body.innerHTML += modal;

            var modalTitleElement = document.createElement('h4');
            modalTitleElement.setAttribute('id', 'tvp-modal-title-{{ $id }}');
            modalTitleElement.setAttribute('class', 'tvp-modal-title');

            if ({{ $.Scratch.Get "settings" }}.modal_title_position === 'top') {
                document.getElementsByClassName('tvp-modal-title-top')[0].appendChild(modalTitleElement)
            } else if ({{ $.Scratch.Get "settings" }}.modal_title_position === 'bottom') {
                modalTitleElement.setAttribute('class', 'tvp-modal-title bottom');
                document.getElementsByClassName('tvp-modal-body')[0].appendChild(modalTitleElement)
            }
        };

        createModal();

        var getIframeHtml = function(options) {
            var html = '<head><base target="_blank" /></head><body class="' + (options.className || '') + '" data-domain="' +
                (options.domain || '') + '" data-id="' + (options.id || '') + '" onload="' +
                'var d = document, head = d.getElementsByTagName(\'head\')[0],' +
                'addJS = function(u){ var s = d.createElement(\'script\');s.src=u;d.body.appendChild(s);},' +
                'addCSS = function(h){ var l = d.createElement(\'link\');l.rel=\'stylesheet\';l.href=h;head.appendChild(l);};';

            var js = options.js || [];
            if ('function' === typeof js) {
                js = js();
            }

            js = js.filter(Boolean);
            for (var i = 0; i < js.length; i++) {
                html += 'addJS(\'' + js[i] + '\');';
            }

            var css = options.css || [];
            if ('function' === typeof css) {
                css = css();
            }

            css = css.filter(Boolean);
            for (var i = 0; i < css.length; i++) {
                html += 'addCSS(\'' + css[i] + '\');';
            }

            html += '"><style>' + (options.style || '') + '</style>';

            var content = options.html || '';
            if ('function' === typeof content) {
                html += content();
            } else if (content.trim().length) {
                html += content;
            }

            return html;
        };

        var addClass = function(obj,c){
            if (!obj || !c) return;
            if ('string' === typeof obj) {
                document.getElementById(obj).classList.add(c);
            } else {
                obj.classList.add(c);
            }
        };

        var removeClass = function(obj,c){
            if (!obj || !c) return;
            if ('string' === typeof obj) {
                document.getElementById(obj).classList.remove(c);
            } else {
                obj.classList.remove(c);
            }
        };

        window.__TVPage__ = window.__TVPage__ || {};
        __TVPage__.config = __TVPage__.config || {};
        __TVPage__.config[widgetId] = extend({{ $.Scratch.Get "settings" }}, __TVPage__.config[widgetId]);

        var config = __TVPage__.config[widgetId];
        config.baseUrl = "{{ .Site.BaseURL }}";
        config.debug = Number('{{ getenv "HUGO_DEBUG" }}') || 0;
        config.staticPath = "{{ .Type | absURL }}";
        config.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        config.isDesktop = !config.isMobile;
        config.mobilePath = config.isMobile ? 'mobile/' : '';
        config.cssPath = config.staticPath + (config.debug ? '/' : '/dist/') + 'css/';
        config.jsPath = config.staticPath + (config.debug ? '/' : '/dist/') + 'js/';
        config.eventPrefix = ("tvp_{{ .Type }}").replace(/-/g,'_');
        config.dataMethod = isset(config, "channel") && isset(config.channel, "id") ? "dynamic" : "static";

        var link = document.createElement("link");
        link.rel = "stylesheet";
        link.href = config.cssPath + config.mobilePath + "host" + (config.debug ? ".css" : ".min.css");
        document.getElementsByTagName("head")[0].appendChild(link);

        var holder = document.getElementById(widgetId + "-holder");
        var iframe = holder.querySelector(".tvp-iframe");
        var isFirefox = /Firefox/i.test(navigator.userAgent);

        if ("dynamic" === config.dataMethod) {

            var iframeContent = getIframeHtml({
                id: widgetId,
                className: "dynamic carousel",
                domain: config.baseUrl,
                style: '{{ replaceRE " +" " " (replaceRE "\n" "" (partial (printf "%s/options.css" .Type ) .)) | safeCSS }}',
                js: [
                    config.debug ? config.jsPath + "/vendor/jquery.js" : "",
                    config.debug ? config.jsPath + "/libs/utils.js" : "",
                    config.debug ? config.jsPath + "/carousel.js" : "",
                    config.debug ? config.jsPath + "/index.js" : "",
                    config.debug ? "" : config.jsPath + "/scripts.min.js"
                ],
                css: [
                    config.debug ? config.cssPath + "/vendor/slick.css" : "",
                    config.debug ? config.cssPath + "/styles.css" : "",
                    config.debug ? "" : config.cssPath + "/styles.min.css"
                ]
            });

            //Firefox does not add the iframe content using the onload method.
            //https://bugzilla.mozilla.org/show_bug.cgi?id=728151
            if (isFirefox) {
                iframe.contentWindow.contents = iframeContent;
                iframe.src = 'javascript:window["contents"]';
            } else {
                var iframeDocument = iframe.contentWindow.document;
                iframeDocument.open().write(iframeContent);
                iframeDocument.close();
            }

        } else {
            var url = config.baseUrl + "/tvpwidget/" + widgetId + "/";
            (-1 === navigator.userAgent.indexOf("MSIE")) ? iframe.src = url: iframe.location = url;
        }

        var isEvent = function (e, type) {
            return (e && isset(e, "data") && isset(e.data, "event") && config.eventPrefix + type === e.data.event);
        };

        var updateModalTitle = function(title){
            document.getElementById('tvp-modal-title-' + widgetId).innerHTML = title || "";
        };

        window.addEventListener("message", function(e){
            if (!isEvent(e, ":resize")) return;
            holder.style.height = e.data.height;
            holder.classList.add('enabled');
        });

        var clickData = {};
        var iframeModalHolder = document.getElementById('tvp-modal-iframe-holder-' + widgetId);
        var iframeModal = null;
        var iframeModalDocument = null;

        window.addEventListener("message", function(e){
            if (!isEvent(e, ":video_click")) return;

            var eventData = e.data;

            clickData = {
                data: eventData.videos,
                selectedVideo: eventData.selectedVideo,
                runTime: (eventData.runTime || (isset(window, '__TVPage__') ? __TVPage__ : {}) ).config[widgetId]
            };

            updateModalTitle(eventData.selectedVideo.title);
            removeClass('tvp-modal-' + widgetId,'tvp-hidden');
            removeClass('tvp-modal-overlay-' + widgetId,'tvp-hidden');

            if (config.fix_page_scroll) {
              addClass(document.body, 'tvp-modal-open');
            }

            iframeModalHolder.innerHTML =  '<iframe class="tvp-iframe-modal" src="about:blank" allowfullscreen frameborder="0" scrolling="no"></iframe>';
            iframeModal = iframeModalHolder.querySelector('.tvp-iframe-modal');
            iframeModalDocument = iframeModal.contentWindow.document;
            iframeModalDocument.open().write(getIframeHtml({
                id: widgetId,
                className: "modal",
                domain: config.baseUrl,
                style: '{{ replaceRE " +" " " (replaceRE "\n" "" (partial (printf "%s/options.css" .Type ) .)) | safeCSS }}',
                html: document.getElementById('tvp-iframe-modal-' + (config.isMobile ? 'mobile-' : '') + 'template').innerHTML,
                js: [
                    "//a.tvpage.com/tvpa.min.js",
                    "https://cdnjs.tvpage.com/tvplayer/tvp-1.8.6.min.js",
                    config.debug && config.isMobile ? config.jsPath + "/vendor/jquery.js" : "",
                    config.debug && config.isDesktop ? config.jsPath + "/vendor/simple-scrollbar.min.js" : "",
                    config.debug ? config.jsPath + "/libs/utils.js" : "",
                    config.debug ? config.jsPath + "/libs/analytics.js" : "",
                    config.debug ? config.jsPath + "/libs/player.js" : "",
                    config.debug ? config.jsPath + "/" + config.mobilePath + "modal/index.js" : "",
                    config.debug ? "" : config.jsPath + config.mobilePath + "modal/scripts.min.js"
                ],
                css: [
                    config.debug ? config.cssPath + "/" + config.mobilePath + "modal/styles.css" : "",
                    config.debug && config.isMobile ? config.cssPath + "/vendor/slick.css" : "",
                    config.debug && config.isDesktop ? config.cssPath + "/vendor/simple-scrollbar.css" : "",
                    config.debug ? "" : config.cssPath + "/" + config.mobilePath + "modal/styles.min.css"
                ]
            }));

            iframeModalDocument.close();
        });

        window.addEventListener("message", function(e){
            if (!isEvent(e, ":modal_initialized")) return;

            if (iframeModal.contentWindow) {
                iframeModal.contentWindow.postMessage({
                    event: config.eventPrefix + ':modal_data',
                    data: clickData.data,
                    selectedVideo: clickData.selectedVideo,
                    runTime: clickData.runTime
                }, '*');
            }

            if (isIOS) {
                var onOrientationChange = function () {
                    if (iframeModal && iframeModal.contentWindow) {
                        var width = iframeModal.parentNode.offsetWidth;
                        iframeModal.contentWindow.window.postMessage({
                            event: config.eventPrefix + ':modal_holder_resize',
                            size: [width, Math.floor(width * (9 / 16))]
                        },'*');
                    }
                };
                var orientationChangeEvent = 'onorientationchange' in window ? 'orientationchange' : 'resize';
                window.removeEventListener(orientationChangeEvent,onOrientationChange, false);
                window.addEventListener(orientationChangeEvent,onOrientationChange, false);
            }
        });

        window.addEventListener("message", function(e) {
            if (!isEvent(e, ":player_next")) return;
            updateModalTitle(e.data.next.assetTitle);
        });

        window.addEventListener("message", function(e) {
            if (!isEvent(e, ":modal_no_products")) return;

            if (config.isDesktop) {
                var label = document.getElementById('tvp-products-headline-' + widgetId);
                if (label) {
                    label.parentNode.removeChild(label);
                }
            }

            removeClass(iframeModalHolder,'products');
            addClass(iframeModalHolder,'no-products');
        });

        window.addEventListener("message", function(e){
            if (!isEvent(e, ":modal_resize")) return;
            iframeModal.style.height = e.data.height;
        });

        window.addEventListener("message", function(e) {
            if (!isEvent(e, ":modal_products")) return;
            if (config.isDesktop && !document.getElementById('tvp-products-headline-' + widgetId)) {
                var label = document.createElement('p');
                addClass(label,'tvp-products-headline');
                label.id = 'tvp-products-headline-' + widgetId;
                label.innerHTML = 'Related Products';
                document.getElementById('tvp-modal-header-' + widgetId).appendChild(label);
            }

            removeClass(iframeModalHolder,'no-products');
            addClass(iframeModalHolder,'products');
        });

        var closeModal = function () {
            addClass('tvp-modal-' + widgetId,'tvp-hidden');
            addClass('tvp-modal-overlay-' + widgetId,'tvp-hidden');

            if (config.fix_page_scroll) {
              removeClass(document.body,'tvp-modal-open');
            }

            removeClass(iframeModalHolder,'products');
            removeClass(iframeModalHolder,'no-products');
            iframeModal.parentNode.removeChild(iframeModal);
        };

        document.getElementById("tvp-modal-close-" + widgetId).addEventListener('click', closeModal, false);

        var modalEl = document.getElementById("tvp-modal-" + widgetId);
        modalEl.addEventListener('click', function(e){
            if (e.target === modalEl || !modalEl.contains(e.target)) {
                closeModal();
            }
        }, false);
    </script>
</div>