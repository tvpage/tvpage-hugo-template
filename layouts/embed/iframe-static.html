{{- partial "settings.html" . -}}
<!doctype html>
<html class='no-js' lang=''>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width,minimum-scale=1,initial-scale=1'>
  <link href='https://www.youtube.com' rel='preconnect' crossorigin>
  <link href='https://cdnjs.tvpage.com' rel='preconnect' crossorigin>
  <link href='https://a.tvpage.com/tvpa.min.js' rel='preconnect' crossorigin>
  <link href='https://s.ytimg.com' rel='preconnect' crossorigin>
  <title>{{ .Title }}</title>
</head>
<body>
  <style>
    body{margin:0;padding:0}.player{height:0;width:100%;position:relative;padding-bottom:56.25%}#player-el{background-repeat:no-repeat;background-position:center;background-size:cover;background-color:#000;position:absolute;top:0;bottom:0;left:0;right:0;width:100%;height:100%}
  </style>
  <div class="player"><div id="player-el"></div></div>
  {{- if(.Params.advertising.enabled) -}}
    <script async type="text/javascript" src="//imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
  {{- end -}}

  <script async src="//a.tvpage.com/tvpa.min.js"></script>
  <script async src='//cdnjs.tvpage.com/tvplayer/tvp-{{ ($.Scratch.Get "settings").player_version }}.min.js'></script>

  {{- if (getenv "HUGO_DEBUG") -}}
    <script src='{{ "libs/analytics.js" | absURL }}'></script>
    <script src='{{ "libs/player.js" | absURL }}'></script>
  {{- else -}}
    <script src='{{ "embed/dist/js/scripts.min.js" | absURL }}'></script>
  {{- end -}}

  <script>
  var playerConfig;

  (function(doc,config,videoId,channelId){

    function getUrlParams(){
      if (!window.location) return;
      var o = {},kv = location.search.substr(1).split('&'), params = [];
      for (var i = 0; i < kv.length; i++) { params.push(kv[i]); }
      for (var i = 0; i < params.length; i++) {
          var param = params[i].split('=');
          if(param[1]) o[param[0]] = param[1];
      }
      return o;
    };

    function extend(out) {
      out = out || {};
      for (var i = 1; i < arguments.length; i++) {
        if (!arguments[i])
          continue;

        for (var key in arguments[i]) {
          if (arguments[i].hasOwnProperty(key))
            out[key] = arguments[i][key];
        }
      }
      return out;
    };

    function isUndefined(obj){
      return 'undefined' !== typeof obj;
    }

    var video;
    {{ if (isset .Params "videoid") }}
      video = {{ index $.Site.Data.videos (printf "x%s" .Params.videoid) }};
    {{ end }}

    var channelVideos;
    {{ if (isset .Params "channelid") }}
      channelVideos = {{ index $.Site.Data.channelVideos (printf "x%s_page_0" .Params.channelid) }};
    {{ end }}

    var videos = [];

    if (videoId) {
      videos.push(video);
    } else if (channelId && !isUndefined(channelVideos.data)) {
      videos = channelVideos.data;
    }

    if (!videos.length)
      return console.log("no data");

    playerConfig = config || {};
    playerConfig.ciTrack = true;
    playerConfig.data = videos;
    playerConfig.templates = {
      "player-overlay": '<div class="tvp-overlay-cover"></div>' +
        '<svg class="tvp-play" viewBox="0 0 200 200">' +
          '<polygon points="70, 55 70, 145 145, 100"></polygon>' +
        '</svg>'
    };
    playerConfig.widgetId = playerConfig.name;
    playerConfig = extend(playerConfig, getUrlParams());

  }(
    document,
    {{ $.Scratch.Get "settings" }},
    {{ with .Params.videoid }}{{ . }}{{ else }}''{{ end }},
    {{ with .Params.channelid }}{{ . }}{{ else }}''{{ end }}
  ));

  var player = new Player('player-el', playerConfig);

  player.initialize();
  </script>
</body>
</html>