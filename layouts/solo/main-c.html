{{ range $i, $def := (getJSON (printf "themes/tvpage/defaults/%s.json" .Type)).option }}
{{ $.Scratch.SetInMap "settings" .code .value }}
{{ end }}
{{ range $i, $param := .Params }}
{{ $.Scratch.SetInMap "settings" $i . }}
{{ end }}
{{ with .Param (.File.BaseFileName) }}
{{ range $i, $opt := . }}
{{ $.Scratch.SetInMap "settings" .code .value }}
{{ end }}
{{ end }}

<style type="text/css">{{ replaceRE " +" " " (replaceRE "\n" "" (partial (printf "%s/css.html" .Type ) .)) | safeCSS }}</style>
<div id="tvpembed-{{ .File.BaseFileName }}">
  <div class="tvpplayer">
    <div id="tvpplayer-target" class="tvpplayer-target"></div>
  </div>
</div>

<script>(function(d,t,id) {
  var s, as = d.getElementsByTagName(t)[0];
  if (d.getElementById(id)) return;
  s = d.createElement(t); s.id = id;
  s.src = "//a.tvpage.com/tvpa.min.js";
  as.parentNode.insertBefore(s, as);
}(document, 'script', 'tvpage-analytics'));</script>
<script>(function(d,t,id) {
  var s, as = d.getElementsByTagName(t)[0];
  if (d.getElementById(id)) return;
  s = d.createElement(t); s.id = id;
  s.src = "http://localhost:1313/solo/player-debug.js";
  as.parentNode.insertBefore(s, as);
}(document, 'script', 'tvpage-player'));</script>

<script>;(function(){
  var mobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
      redefine = function(o, pr){return 'undefined' !== typeof o[pr];},
      buildAsset = function(v){
        if (!v || !v.asset) return console.log("no asset");
        var a = v.asset;
        a.analyticsObj = {vd:v.id,li:v.loginId,pg:v.parentId?v.parentId:0};
        if (!a.sources) a.sources = [{ file: a.videoId }];
        a.type = a.type || 'youtube';
        return a;
      };
  
  window.addEventListener('message',function(e) {
    if (!e || !redefine(e,'origin') || 'http://localhost:1313' !== e.origin || !redefine(e,'data')) return;
    var checks = 0, asset = buildAsset(event.data[0]);
    (function libsPoller() {
      var deferred = setTimeout(function() {
        if ( !redefine(window,'_tvpa') || !redefine(window,'TVPage')) {
          if (++checks < 10) {
            libsPoller();
          } else { 
            console.log("reached checks limit"); 
          }
        } else {
          _tvpa.push(["config", {li:'{{ .Param "loginid" }}',gaDomain:"www.tvpage.tv", "logUrl": "\/\/api.tvpage.com\/v1\/__tvpa.gif"}]);
          _tvpa.push(["track","ci",{ li: '{{ .Param "loginid" }}'}]);
          var inst, playerEl;
          new TVPage.player({
            divId: "tvpplayer-target",
            controls: {
              active: true,
              seekBar: { progressColor: {{ ($.Scratch.Get "settings").progresscolor }} },
              floater: { removeControls: {{ ($.Scratch.Get "settings").removecontrols }}, transcript: {{ ($.Scratch.Get "settings").transcript }} }
            },
            poster: true,
            techOrder: 'html5,flash',
            analytics: { tvpa: false },
            apiBaseUrl: '//app.tvpage.com',
            swf: '//d2kmhr1caomykv.cloudfront.net/player/assets/tvp/tvp-{{ ($.Scratch.Get "settings").version }}-flash.swf',
            onReady: function(e, player){
              inst = player;
              if (redefine(inst,'options') && redefine(inst.options,'DOMContainer')) {
                playerEl = inst.options.DOMContainer;
              }
              var resize = function(){inst.resize(playerEl.clientWidth, playerEl.clientHeight);};
              resize();
              window.onresize = resize;
              playerEl.getElementsByClassName('tvp-progress-bar')[0].style["background-color"] = inst.options.controls.seekBar.progressColor;
              
              if(mobile || !{{ ($.Scratch.Get "settings").autoplay }}){
                inst.cueVideo(asset);
                if (asset.type == 'mp4') addBtn(inst);
              }else{
                inst.loadVideo(asset);
              }
            },
            onStateChange: function(e){
              if(e && 'tvp:media:videoended' === e){
                if(mobile || !{{ ($.Scratch.Get "settings").autonext }}){
                  inst.cueVideo(asset);
                  if (asset.type == 'mp4') addBtn(inst);
                }else{
                  inst.loadVideo(asset);
                }         
              }
            }
          });
        }
      }, 300);
    })();

  },false);

  

}());</script>