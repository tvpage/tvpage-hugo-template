{{ range $i, $def := (getJSON (printf "themes/tvpage/defaults/%s.json" .Type)).option }}
{{ $.Scratch.SetInMap "settings" .code .value }}
{{ end }}
{{ range $i, $param := .Params }}
{{ $.Scratch.SetInMap "settings" $i . }}
{{ end }}
{{ with .Param (.File.BaseFileName) }}
{{ range $i, $opt := . }}
{{ $.Scratch.SetInMap "settings" .code .value }}
{{ end }}
{{ end }}

<style type="text/css">{{ replaceRE " +" " " (replaceRE "\n" "" (partial (printf "%s/css.html" .Type ) .)) | safeCSS }}</style>
<div class="tvpplayer">
  <div id="tvpplayer-target"></div>
</div>
<script src="//a.tvpage.com/tvpa.min.js"></script>
<script src="http://localhost:1313/solo/player-debug.js"></script>

<script>;(function(){
  var putButtonOverlay = function(inst){
    var ele = document.createElement("div");
    ele.className = "tvpplayer-play";
    var selector = inst.options.DOMContainer.id;
    document.getElementById(selector).parentNode.insertBefore(ele, document.getElementById(selector).nextSibling).addEventListener('click', function(){
      this.remove();
      if(inst) inst.play();
    },false);
  };
  var asset = function(video){
    if (!video || !video.asset) return console.log("no asset");
    var asset = video.asset;
    asset.analyticsObj = { vd: video.id, li: video.loginId, pg: video.parentId ? video.parentId : 0 };
    if (!asset.sources) asset.sources = [{ file: asset.videoId }];
    asset.type = asset.type || 'youtube';
    return asset;
  };
  var mobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  var checks = 0;
  var index = 0;
  (function libsPoller() {
    var deferred = setTimeout(function() {
      if ("undefined" === typeof window._tvpa || "undefined" === typeof window.TVPage) {
        if (++checks < 10) {
          libsPoller();
        } else { 
          console.log("reached checks limit"); 
        }
      } else {
        _tvpa.push(["config", { li: '{{ .Param "loginid" }}', gaDomain:"www.tvpage.tv", "logUrl": "\/\/api.tvpage.com\/v1\/__tvpa.gif"}]);
        _tvpa.push(["track","ci",{ li: '{{ .Param "loginid" }}'}]);
        var instance, assetsList = [];
        new TVPage.player({
          divId: "tvpplayer-target",
          controls: {
            active: true,
            seekBar: { progressColor: {{ ($.Scratch.Get "settings").progresscolor }} },
            floater: { removeControls: {{ ($.Scratch.Get "settings").removecontrols }}, transcript: {{ ($.Scratch.Get "settings").transcript }} }
          },
          poster: true,
          techOrder: 'html5,flash',
          analytics: { tvpa: false },
          apiBaseUrl: '//app.tvpage.com',
          swf: '//d2kmhr1caomykv.cloudfront.net/player/assets/tvp/tvp-{{ ($.Scratch.Get "settings").version }}-flash.swf',
          onReady: function(e, player){
            instance = player;
            var resize = function(){instance.resize(instance.options.DOMContainer.clientWidth, instance.options.DOMContainer.clientHeight);};
            resize();
            window.onresize = resize;
            instance.options.DOMContainer.getElementsByClassName('tvp-progress-bar')[0].style["background-color"] = instance.options.controls.seekBar.progressColor;

            var videoid;
            {{ with .Params.videoid }} videoid = {{ . }};{{ end }}
            var channelid;
            {{ with .Params.channelid }} channelid = {{ . }};{{ end }}

            if (!videoid && channelid) {
              var channelVideos = {{ index $.Site.Data.channelVideos (printf "x%s_page_1" .Params.channelid) }};
              assetsList = channelVideos.data;
            } else{
              assetsList.push({{ index $.Site.Data.videos (printf "x%s" .Params.videoid) }});
            }

            if(mobile || !{{ ($.Scratch.Get "settings").autoplay }}){
              instance.cueVideo(asset(assetsList[index]));
              if (asset.type == 'mp4') putButtonOverlay(instance);
            }else{
              instance.loadVideo(asset(assetsList[index]));
            }
          },
          onStateChange: function(e){
            if("undefined" !== typeof e && "tvp:media:videoended" == e){
              index = (index == assetsList.length - 1) ? 0 : index + 1;
              if(mobile || !{{ ($.Scratch.Get "settings").autonext }}){
                instance.cueVideo(asset(assetsList[index]));
                if (asset.type == 'mp4') putButtonOverlay(instance);
              }else{
                instance.loadVideo(asset(assetsList[index]));
              }         
            }
          }
        });
      }
    }, 300);
  })();

}());</script>