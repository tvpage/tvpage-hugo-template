{{- partial "settings.html" . -}}
<style>{{ replaceRE " +" " " (replaceRE "\n" "" (partial (printf "%s/css-modal-mobile.css" .Type ) .)) | safeCSS }}</style>
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.6.0/slick.min.css">
<div id='{{ ($.Scratch.Get "settings").name }}' class="iframe-content">
  <div class="tvp-player">
    <div class="tvp-modal-header">
    <h4 class="tvp-modal-title"></h4>
  </div>
    <div id="tvp-player-el"></div>
    <svg class="tvp-play" viewBox="0 0 200 200" alt="Play video"><polygon points="70, 55 70, 145 145, 100" fill="#e57211"></polygon></svg>
  </div>
  <div id="tvp-product-container">
    <p class="tvp-products-title">Recommended Products</p>
    <div class="tvp-products"></div>
  </div>
</div>
<script id="productTemplate" type="text/template">
  <a class="tvp-product" href="{linkUrl}" target="_parent">
    <div class="tvp-product-image" style="background-image:url('{imageUrl}');"></div>
    <div class="tvp-product-data">
      <p>{title}</p>
      <h2>{price}</h2>
      <button>View Details</button>
    </div>
  </a>
</script>
<script src="//a.tvpage.com/tvpa.min.js"></script>
<script src="//appcdn.tvpage.com/player/assets/tvp/tvp-{{ ($.Scratch.Get "settings").version }}-min.js"></script>
<script src="{{.Site.BaseURL}}player.js"></script>
<script src="{{.Site.BaseURL}}{{.Type}}/vendor/jquery.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.6.0/slick.min.js"></script>
<!-- <script src="{{.Site.BaseURL}}{{.Type}}/vendor/iscroll.js"></script> -->

<script>(function(doc,parentDoc){
 
 var settings = {{ $.Scratch.Get "settings" }};

 var tmpl = function(template, data) {
    if (data.title.length > 42){
      var shortTitle = jQuery.trim(data.title).substring(0, 42).split(" ").slice(0, -1).join(" ")+" ...";
      data.title = shortTitle;
    }
    if (template && 'object' == typeof data) {
      return template.replace(/\{([\w\.]*)\}/g, function(str, key) {
        var keys = key.split("."),
          v = data[keys.shift()];
        for (var i = 0, l = keys.length; i < l; i++) v = v[keys[i]];
        return (typeof v !== "undefined" && v !== null) ? v : "";
      });
    }
  };

  var debounce = function(func,wait,immediate) {
    var timeout;  
    return function() {
      var context = this, args = arguments;
      var later = function() {
        timeout = null;
        if (!immediate) func.apply(context, args);
      };
      var callNow = immediate && !timeout;
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
      if (callNow) func.apply(context, args);
    };
  };

  var isset = function(o,p){
    var val = o;
    if (p) val = o[p];
    return 'undefined' !== typeof val;
  };
  
  window.addEventListener('message',function(e){
    if (!e || !isset(e,'origin') || 'http://localhost:1313' !== e.origin || !isset(e,'data') || !isset(e.data,'videos')) return;

    var $el = $('#' + settings.name),
        data = e.data,
        selected = data.selected;
    
    settings.data = data.videos;

    for (var i = 0; i < settings.data.length; i++) {
      if(settings.data[i].id == selected){
        if (settings.data[i].title.length > 42){
            var shortTitle = jQuery.trim(settings.data[i].title).substring(0, 42).split(" ").slice(0, -1).join(" ")+" ...";
            settings.data[i].title = shortTitle;
            $el.find('.tvp-modal-title').html(settings.data[i].title);
        }else{
          $el.find('.tvp-modal-title').html(settings.data[i].title);
        }
      }
    }

    new Player('tvp-player-el',settings,selected);

    var $overlay = $(parentDoc).find('.tvp-modal-overlay');
    $overlay.click(function(){$(this).off().remove();});
    $(doc).find('.tvp-close-btn').click(function(){$overlay.off().remove();});

    $.ajax({
      type: 'GET',
      url: '//api.tvpage.com/v1/videos/' + selected + '/products',
      dataType: 'jsonp',
      data: {
        'X-login-id': settings.loginid
      }
    }).done(function(products){
      if (!products && !products.length) return console.log('no products');

      var prodCount = products.length,
          prodTmpl = $('#productTemplate').html(),
          prodsHtml = '';

      while (prodCount > 0) {
        prodsHtml += '<div>' + tmpl(prodTmpl, products[prodCount-1]) + '</div>';
        prodCount--;
      }

      var $products = $('#' + settings.name).find('.tvp-products');
      $products.html(prodsHtml);
      setTimeout(function(){
        $products.slick({
          slidesToSlide: 1,
          slidesToShow: 1
        });
      },0);

    });

  });

}(document,parent.document));</script>